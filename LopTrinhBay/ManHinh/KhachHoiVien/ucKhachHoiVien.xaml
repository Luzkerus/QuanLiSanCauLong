<UserControl x:Class="QuanLiSanCauLong.LopTrinhBay.ManHinh.KhachHoiVien.ucKhachHoiVien"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="760" d:DesignWidth="1280"
             Background="#F6FDF9">

    <UserControl.Resources>
        <!-- ===== Palette ===== -->
        <SolidColorBrush x:Key="ColBg" Color="#F6FDF9"/>
        <SolidColorBrush x:Key="ColCard" Color="White"/>
        <SolidColorBrush x:Key="ColText" Color="#21382D"/>
        <SolidColorBrush x:Key="ColSub"  Color="#6B7E74"/>
        <SolidColorBrush x:Key="ColPrimary" Color="#0FBF84"/>

        <!-- Card -->
        <Style x:Key="Card" TargetType="Border">
            <Setter Property="CornerRadius" Value="16"/>
            <Setter Property="Background" Value="{StaticResource ColCard}"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="Margin" Value="8"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="12" ShadowDepth="0" Opacity="0.12"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Badge hạng -->
        <Style x:Key="RankBadge" TargetType="Border">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="10,2"/>
            <Setter Property="Background" Value="#F1F5F9"/>
            <Setter Property="BorderBrush" Value="#E2E8F0"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <!-- DataGrid base -->
        <Style TargetType="DataGrid">
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="RowHeight" Value="52"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="CanUserResizeRows" Value="False"/>
            <Setter Property="SelectionMode" Value="Single"/>
            <Setter Property="AlternationCount" Value="2"/>
            <Setter Property="Margin" Value="0"/>
        </Style>

        <!-- Avatar chấm tròn -->
        <DataTemplate x:Key="AvatarTemplate">
            <Border Width="36" Height="36" CornerRadius="18" Background="#E6F9F2">
                <TextBlock Text="{Binding Initials}"
                           HorizontalAlignment="Center" VerticalAlignment="Center"
                           Foreground="#0FBF84" FontWeight="Bold"/>
            </Border>
        </DataTemplate>

        <!-- Badge màu theo Hạng -->
        <Style x:Key="RankPill" TargetType="Border" BasedOn="{StaticResource RankBadge}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Hang}" Value="Vàng">
                    <Setter Property="Background" Value="#FFF8E1"/>
                    <Setter Property="BorderBrush" Value="#FBC02D"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Hang}" Value="Bạc">
                    <Setter Property="Background" Value="#ECEFF1"/>
                    <Setter Property="BorderBrush" Value="#90A4AE"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Hang}" Value="Đồng">
                    <Setter Property="Background" Value="#FFEFE6"/>
                    <Setter Property="BorderBrush" Value="#FB8C00"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- View lọc tìm kiếm -->
        <CollectionViewSource x:Key="cvsMembers" Source="{Binding Members}"
                             />
    </UserControl.Resources>

    <Grid Margin="16">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="305*"/>
            <ColumnDefinition Width="7*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Header -->
            <RowDefinition Height="Auto"/>
            <!-- KPI -->
            <RowDefinition Height="Auto"/>
            <!-- Search -->
            <RowDefinition/>
            <!-- Table -->
        </Grid.RowDefinitions>

        <!-- ===== Header ===== -->
        <DockPanel Grid.Row="0" LastChildFill="False" Margin="0,0,0,8">
            <TextBlock Text="Quản lý khách hàng &amp; Hội viên" Foreground="{StaticResource ColText}"
                       FontSize="20" FontWeight="SemiBold" VerticalAlignment="Center" />
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" >
                <Button Background="#0FBF84" Foreground="White">
                    + Thêm khách hàng
                </Button>
            </StackPanel>
        </DockPanel>

        <!-- ===== KPI cards (4 cột) ===== -->
        <UniformGrid Grid.Row="1" Columns="4" Margin="0,0,0,8" Grid.ColumnSpan="2">
            <!-- Tổng hội viên -->
            <Border Style="{StaticResource Card}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <TextBlock Text="Tổng hội viên" Foreground="{StaticResource ColSub}"/>
                        <TextBlock Text="{Binding KpiTong}" FontSize="24" FontWeight="Bold"
                                   Foreground="{StaticResource ColText}"/>
                    </StackPanel>
                    <Border Grid.Column="1" Width="36" Height="36" CornerRadius="18"
                            Background="#E6F9F2" HorizontalAlignment="Right">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text=""
                                   Foreground="#0FBF84"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Border>

            <!-- Hạng Vàng -->
            <Border Style="{StaticResource Card}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <TextBlock Text="Hạng Vàng" Foreground="{StaticResource ColSub}"/>
                        <TextBlock Text="{Binding KpiVang}" FontSize="24" FontWeight="Bold"
                                   Foreground="{StaticResource ColText}"/>
                    </StackPanel>
                    <Border Grid.Column="1" Width="36" Height="36" CornerRadius="8"
                            Background="#FFF8E1" BorderBrush="#FBC02D" BorderThickness="1">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text=""
                                   HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#FBC02D"/>
                    </Border>
                </Grid>
            </Border>

            <!-- Hạng Bạc -->
            <Border Style="{StaticResource Card}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <TextBlock Text="Hạng Bạc" Foreground="{StaticResource ColSub}"/>
                        <TextBlock Text="{Binding KpiBac}" FontSize="24" FontWeight="Bold"
                                   Foreground="{StaticResource ColText}"/>
                    </StackPanel>
                    <Border Grid.Column="1" Width="36" Height="36" CornerRadius="8"
                            Background="#ECEFF1" BorderBrush="#90A4AE" BorderThickness="1">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text=""
                                   HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#607D8B"/>
                    </Border>
                </Grid>
            </Border>

            <!-- Hoạt động trong tuần -->
            <Border Style="{StaticResource Card}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <TextBlock Text="Hoạt động trong tuần" Foreground="{StaticResource ColSub}"/>
                        <TextBlock Text="{Binding KpiActiveWeek}" FontSize="24" FontWeight="Bold"
                                   Foreground="{StaticResource ColText}"/>
                    </StackPanel>
                    <Border Grid.Column="1" Width="36" Height="36" CornerRadius="8"
                            Background="#E6F9F2" BorderBrush="#0FBF84" BorderThickness="1">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text=""
                                   HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#0FBF84"/>
                    </Border>
                </Grid>
            </Border>
        </UniformGrid>

        <!-- ===== Search (WPF watermark, không dùng PlaceholderText) ===== -->
        <Border Grid.Row="2" Style="{StaticResource Card}" Padding="12" Grid.ColumnSpan="2" Margin="8,8,8,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- TextBox + watermark overlay -->
                <Grid Grid.Column="0">
                    <TextBox x:Name="txtSearch"
                             Height="36" Margin="0,0,8,0"
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             ToolTip="Tìm theo tên hoặc SĐT..." />
                    <TextBlock Margin="10,0,0,0"
                               VerticalAlignment="Center"
                               Foreground="#9AA5A1"
                               IsHitTestVisible="False"
                               Text="Tìm theo tên hoặc SĐT...">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Text, ElementName=txtSearch}" Value="">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <CheckBox Content="Chỉ Hội viên" Margin="8,0,0,0"
                              IsChecked="{Binding OnlyMembers}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ===== Table ===== -->
        <Border Grid.Row="3" Style="{StaticResource Card}" Padding="0" Grid.ColumnSpan="2" Margin="8,8,8,8">
            <DataGrid ItemsSource="{Binding Source={StaticResource cvsMembers}}"
                      IsReadOnly="True">
                <DataGrid.Columns>

                    <!-- Họ tên + avatar (không dùng Spacing, dùng Margin) -->
                    <DataGridTemplateColumn Header="Hội viên" MinWidth="220">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <ContentControl ContentTemplate="{StaticResource AvatarTemplate}" Margin="0,0,8,0"/>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Ten}" Foreground="{StaticResource ColText}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding SDT}" Foreground="{StaticResource ColSub}" FontSize="12"/>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Email" Binding="{Binding Email}" MinWidth="210"/>
                    <DataGridTextColumn Header="Điểm TL" Binding="{Binding DiemTL}" MinWidth="90"/>
                    <DataGridTextColumn Header="Số lượt" Binding="{Binding SoLuot}" MinWidth="80"/>

                    <DataGridTemplateColumn Header="Hạng" MinWidth="90">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource RankPill}">
                                    <TextBlock Text="{Binding Hang}" Margin="2,0" VerticalAlignment="Center"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Lần cuối"
                                        Binding="{Binding LanCuoi, StringFormat=\{0:dd/MM/yyyy\}}"
                                        MinWidth="120"/>

                    <DataGridTemplateColumn Header="Thao tác" MinWidth="100">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Button Command="{Binding DataContext.CmdEdit, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Sửa" Cursor="Hand"
                                            Margin="0,0,6,0" Padding="8,4">
                                        <TextBlock FontFamily="Segoe MDL2 Assets" Text=""/>
                                    </Button>
                                    <Button Command="{Binding DataContext.CmdDelete, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Xóa" Cursor="Hand"
                                            Padding="8,4">
                                        <TextBlock FontFamily="Segoe MDL2 Assets" Text=""/>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                </DataGrid.Columns>
            </DataGrid>
        </Border>
    </Grid>
</UserControl>
